---
kind: pipeline
type: docker
name: default
trigger:
  event:
    exclude:
    - pull_request

steps:
- name: setup-general
  image: allgreed/nix:2.3.6
  commands:
  - echo -n "latest,preview$DRONE_COMMIT_SHA" > .tags

- name: container-backend
  image: allgreed/nix:2.3.6
  commands:
  - cd back
  - nix-shell --quiet --run 'make create-container'
  - cp $(readlink -f docker-image.tar.gz) ../docker-image.tar.gz # need to persist the image between stages and Drone only mounts CWD, so symlinks would fail
## TODO: odgównić ścieżkę? i zrobić przenoszenie zamiast kopiowania
#
- name: load-and-push-backend
  image: allgreed/nix:2.3.6
  commands:
  - nix-env --quiet -iA nixpkgs.podman
  - export REPOTAG=allgreed/big-pairing-back:latest
  - podman --storage-driver=vfs login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD docker.io
  - podman --storage-driver=vfs load -i docker-image.tar.gz  | cut -f 2,3 -d':' > .loaded-image-tag
  - podman --storage-driver=vfs tag `cat .loaded-image-tag` $REPOTAG
  - podman --storage-driver=vfs push $REPOTAG
  - podman --storage-driver=vfs tag $REPOTAG allgreed/big-pairing-back:preview$DRONE_COMMIT_SHA
  - podman --storage-driver=vfs push allgreed/big-pairing-back:preview$DRONE_COMMIT_SHA 
  - podman --storage-driver=vfs logout
  environment:
    DOCKER_PASSWORD:
        from_secret: docker_password
    DOCKER_USERNAME:
        from_secret: docker_username
  when:
    branch:
    - master

- name: build-frontend
  image: node:13
  commands:
  - cd front
  - npm install
  - npm run build

- name: build-and-push-frontend
  image: plugins/docker
  settings:
    username:
      from_secret: docker_username
    password:
      from_secret: docker_password
    repo: allgreed/big-pairing-front
    context: ./front
    dockerfile: ./front/Dockerfile
  when:
    branch:
    - master

- name: deploy
  image: allgreed/nix:2.3.6
  environment:
    NOMAD_URL:
      from_secret: nomad_url
  commands:
  - VERSION=preview$DRONE_COMMIT_SHA ./deploy.nomad.tpl > deploy.nomad
  - NOMAD_URL=$NOMAD_URL nix-shell --quiet --run "nomad job run -address=$NOMAD_URL deploy.nomad"
  when:
    branch:
    - master
